version: '3.6'
# Volumes are HOST directory and then CONTAINER directory

services:
  # Postgresql server
  mktestdatabase:
    image: mediakraken/mkdatabase:refactor
    environment:
      - MAX_CONNECTIONS=10
      - MAX_WAL_SENDERS=2
      - SHARED_BUFFERS=1024MB
      - WORK_MEM=256MB
      - MAX_WORKER_PROCESSES=4
      - MAX_PARALLEL_WORKERS_PER_GATHER=2
      - MAX_PARALLEL_WORKERS=4
      - POSTGRES_PASSWORD=metaman
    command: postgres -c logging_collector=on -c log_directory='/var/log/postgresql' -c log_filename='postgresql-%Y-%m-%d_%H%M%S.log' -c log_statement='all' -c log_duration=on -c log_connections=off -c log_disconnections=off
    container_name: mktest_database
    stop_grace_period: 30s
    stop_signal: SIGTERM
    volumes:
      - mediakraken_vol_test_postgresql:/var/lib/postgresql/data
      - mediakraken_vol_test_postgresql_logging:/var/log/postgresql
    networks:
      - mediakraken_test_network
    ports:
      - "15432:5432"
    restart: unless-stopped

  mktestelk:
    image: mediakraken/mkelk:refactor
    environment:
      - ELASTICSEARCH_START=1
      - LOGSTASH_START=1
      - KIBANA_START=1
    container_name: mktest_elk
    stop_grace_period: 30s
    stop_signal: SIGTERM
    volumes:
      - mediakraken_vol_test_elk:/var/lib/elasticsearch
    networks:
      - mediakraken_test_network
    ports:
      - "5000:5000"
      - "5044:5044"
      - "5601:5601"
      - "9200:9200"
    restart: unless-stopped

  mktestjenkins:
    image: mediakraken/mkjenkins:refactor
    stop_grace_period: 30s
    stop_signal: SIGTERM
    container_name: mktest_jenkins
    networks:
      - mediakraken_test_network
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - mediakraken_vol_test_jenkins:/var/jenkins_home

  # database management tool
  mktestpgadmin:
    image: dpage/pgadmin4:6.3
    stop_grace_period: 30s
    stop_signal: SIGTERM
    container_name: mktest_pgadmin
    networks:
      - mediakraken_test_network
    ports:
      - "15050:5050"
    environment:
      PGADMIN_LISTEN_PORT: 5050
      PGADMIN_DEFAULT_EMAIL: spootdev@gmail.com
      PGADMIN_DEFAULT_PASSWORD: metaman
      PGADMIN_DISABLE_POSTFIX: 1
    volumes:
      - mediakraken_vol_test_pgadmin:/var/lib/pgadmin

  # package cache tool
  mktestsonatype:
    image: sonatype/nexus3:3.37.3
    stop_grace_period: 30s
    stop_signal: SIGTERM
    container_name: mktest_sonatype
    networks:
      - mediakraken_test_network
    ports:
      - "8081:8081"
    volumes:
      - mediakraken_vol_test_sonatype:/nexus-data
      - /var/opt/mediakraken/sonatype/deploy:/opt/sonatype/nexus/deploy

  mktestteamcity:
    image: jetbrains/teamcity-server:2021.2.1
    stop_grace_period: 30s
    stop_signal: SIGTERM
    container_name: mktest_teamcity_server
    networks:
      - mediakraken_test_network
    ports:
      - "8111:8111"
    volumes:
      - mediakraken_vol_test_teamcity:/data/teamcity_server/datadir
      - mediakraken_vol_test_teamcity_logs:/opt/teamcity/logs

  mktestteamcityagent:
    image: jetbrains/teamcity-agent:2021.2.1
    stop_grace_period: 30s
    stop_signal: SIGTERM
    container_name: mktest_teamcity_agent
    environment:
      SERVER_URL: "http://th-mkbuild-1.beaverbay.local:8111"
    networks:
      - mediakraken_test_network
    volumes:
      - mediakraken_vol_test_teamcity_agent:/teamcity_agent/conf
      - /var/run/docker.sock:/var/run/docker.sock

  mktesttrac:
    image: mediakraken/mktrac:refactor
    stop_grace_period: 30s
    stop_signal: SIGTERM
    container_name: mktest_trac
    networks:
      - mediakraken_test_network
    ports:
      - "18080:80"
    volumes:
      - /var/opt/mediakraken/trac:/trac

networks:
  mediakraken_test_network:
    driver: bridge
    name: mk_mediakraken_test_network

volumes:
  mediakraken_vol_test_elk:
  mediakraken_vol_test_jenkins:
  mediakraken_vol_test_pgadmin:
  mediakraken_vol_test_postgresql:
  mediakraken_vol_test_postgresql_logging:
  mediakraken_vol_test_sonatype:
  mediakraken_vol_test_teamcity:
  mediakraken_vol_test_teamcity_logs:
  mediakraken_vol_test_teamcity_agent: