version: '3.6'
# Volumes are HOST directory and then CONTAINER directory

services:
  # Postgresql server
  mktestdatabase:
    image: mediakraken/mkdatabase:dev
    environment:
      - MAX_CONNECTIONS=10
      - MAX_WAL_SENDERS=2
      - SHARED_BUFFERS=1024MB
      - WORK_MEM=256MB
      - MAX_WORKER_PROCESSES=4
      - MAX_PARALLEL_WORKERS_PER_GATHER=2
      - MAX_PARALLEL_WORKERS=4
      - POSTGRES_PASSWORD=metaman
    command: postgres -c logging_collector=on -c log_directory='/var/log/postgresql' -c log_filename='postgresql-%Y-%m-%d_%H%M%S.log' -c log_statement='all' -c log_duration=on -c log_connections=off -c log_disconnections=off
    container_name: mkdatabase
    stop_grace_period: 30s
    stop_signal: SIGTERM
    volumes:
      - mediakraken_vol_test_postgresql:/var/lib/postgresql/data
      - mediakraken_vol_test_postgresql_logging:/var/log/postgresql
    networks:
      - mediakraken_test_network
    ports:
      - "5432:5432"
    restart: unless-stopped

  # database management tool
  mktestpgadmin:
    image: dpage/pgadmin4:6.15
    stop_grace_period: 30s
    stop_signal: SIGTERM
    container_name: mkpgadmin
    networks:
      - mediakraken_test_network
    ports:
      - "5050:5050"
    environment:
      PGADMIN_LISTEN_PORT: 5050
      PGADMIN_DEFAULT_EMAIL: spootdev@gmail.com
      PGADMIN_DEFAULT_PASSWORD: metaman
      PGADMIN_DISABLE_POSTFIX: 1
    volumes:
      - mediakraken_vol_test_pgadmin:/var/lib/pgadmin

#  mktestteamcity:
#    image: jetbrains/teamcity-server:2021.2.1
#    stop_grace_period: 30s
#    stop_signal: SIGTERM
#    container_name: mktest_teamcity_server
#    networks:
#      - mediakraken_test_network
#    ports:
#      - "8111:8111"
#    volumes:
#      - mediakraken_vol_test_teamcity:/data/teamcity_server/datadir
#      - mediakraken_vol_test_teamcity_logs:/opt/teamcity/logs
#    depends_on:
#      - mktestteamcitydb

#  mktestteamcityagent:
#    image: jetbrains/teamcity-agent:2021.2.1-linux-sudo
#    stop_grace_period: 30s
#    stop_signal: SIGTERM
#    container_name: mktest_teamcity_agent
#    privileged: true
#    environment:
#      SERVER_URL: "http://th-mkbuild-1.beaverbay.local:8111"
#      DOCKER_IN_DOCKER: start
#    networks:
#      - mediakraken_test_network
#    volumes:
#      - mediakraken_vol_test_teamcity_agent:/teamcity_agent/conf
#      - /var/run/docker.sock:/var/run/docker.sock

#  mktestteamcitydb:
#    image: postgres:14.1-bullseye
#    stop_grace_period: 30s
#    stop_signal: SIGTERM
#    container_name: mktest_teamcity_db
#    ports:
#      - "5432:5432"
#    environment:
#      - POSTGRES_PASSWORD=metaman
#      - POSTGRES_USER=metaman
#      - POSTGRES_DB=mkdbserver
#      - PG_DATA=/var/lib/postgresql/data
#    networks:
#      - mediakraken_test_network
#    volumes:
#      - mediakraken_vol_test_teamcity_db:/var/lib/postgresql/data

#  mktesttrac:
#    image: mediakraken/mktrac:dev
#    stop_grace_period: 30s
#    stop_signal: SIGTERM
#    container_name: mktest_trac
#    networks:
#      - mediakraken_test_network
#    ports:
#      - "18080:80"
#    volumes:
#      - /var/opt/mediakraken/trac:/trac

networks:
  mediakraken_test_network:
    driver: bridge
    name: mk_mediakraken_test_network

volumes:
  mediakraken_vol_test_pgadmin:
  mediakraken_vol_test_postgresql:
  mediakraken_vol_test_postgresql_logging:
#  mediakraken_vol_test_teamcity:
#  mediakraken_vol_test_teamcity_logs:
#  mediakraken_vol_test_teamcity_agent:
#  mediakraken_vol_test_teamcity_db: